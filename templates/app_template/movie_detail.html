{% extends "base.html" %}
{% load static %}
{% load account %}

{% block title %}{{ movie.name }}{% endblock %}
{% block stylesheet %} 
    <link rel="stylesheet" href="{% static 'css/movie-detail.css' %}">
{% endblock %}

{% block content %}
    <div class="container">
        <div class="movie">
            <div class="row ">
                <div class="col-md-4">
                    <img class="img-fluid w-100" src="{{ movie.image.url }}" alt="poster">
                </div>
                <div class="col-md-8">
                    <h3 class="movie-name">{{ movie.name }}</h3>
                    <p class="duration"> <strong>Тривалість фільма:</strong> {{ movie.duration_film }} </p>
                    <p class="contry"> <strong>Країна: </strong> {{ movie.contry }}</p>
                    <p class="genre"> <strong>Жанри: </strong> 
                        {% for genre in movie.genre.all %}
                        {{ genre.name }},
                        {% endfor %}
                    </p>
                    <p class="actors"> <strong>Актори</strong> 
                        {% for actor in movie.actor.all %}
                            <a href="{% url 'app:actor_detail' actor.id %}"> {{ actor.name }}</a>,
                        {% endfor %}
                    </p>
                    <p class="director"> <strong>Режисер:</strong> 
                        {% for director in movie.directors.all %}
                            <a href="{% url 'app:actor_detail' director.id %}"> {{ director.name }}</a>
                        {% endfor %}
                    </p>
                    <p class="premiere"> <strong>Прем’єра: </strong> {{ movie.premiere }}</p>
                    <p class="budget"> <strong>Бюджет</strong>  {{ movie.budget }}</p>
                    
                    <a href="#"><i class="fab fa-youtube"></i> Подивитись трейлер</a> <br>  

                    <a href="{% url 'app:sessions' %}" class="btn btn-primary mt-5">Заброювати місце</a>
                
                </div>
            </div>
            <h4 class="mt-3">Описание</h4><br><p class='desc-detail '></p>{{ movie.desc }} </p>

            <div class="embed-responsive embed-responsive-16by9 my-4">
                <iframe class="embed-responsive-item" src="//www.youtube.com/embed/48OJbbI0DfE" allowfullscreen></iframe>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                {% user_display user as user_display %}

                    <form id="formReview" action="" method="POST">
                        {% csrf_token %}
                        <fieldset disabled>
                            <div class="form-group">
                                <input type="text" name="name" id="disabledTextInput" class="form-control" placeholder="{% if not user.is_anonymous %}{{ user.username }}{% else %}Гiсть{% endif %}">
                            </div>
                        </fieldset>
                        <textarea name="comment" id="comment" class="form-control" rows="3" required></textarea>
                        <input class="btn btn-primary form-control mt-2" type="submit" value="залишити коментарий">
                    </form>
                
                    
                
                <h4 class="mt-5">Новини</h4>
                {% for articl in article|slice:"5" %}
                <div class="card my-4 bg-light">
                    <div class="card-header">
                        <a class="text-muted" href="{% url 'news:news_detail' articl.url %}">{{ articl.title }}</a>
                    </div>
                    <div class="card-body">
                        {{ articl.short_describe }}
                    </div>
                </div>
                {% endfor %}
            </div>
                <div class="col-md-8">
                    <div id="accordion" role="tablist">
                        <div class="card">
                            <div class="card-header" role="tab" id="headingOne">
                                <h5 class="mb-0">
                                    <a data-toggle="collapse" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                        коментарi
                                    </a>
                                </h5>
                            </div>
                            <div id="collapseOne" class="collapse show" role="tabpanel" aria-labelledby="headingOne">
                                <div class="card-body_comment">
                                    {% for comment in comments %}
                                        <div class="row d-flex p-3 my-3 review-{{comment.id}}" >
                                            <div class="col-md-2">
                                                <img class="img-fluid" src="{% static 'img/user.png' %}" alt="user">
                                            </div>
                                            <div class="col-md-10 comment">
                                                <strong>{% if user.is_anonymous %}Гiсть{% else %}{% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}{% endif %}</strong> <br>
                                                <p id="review_for_page">{{ comment.comment }}</p>
                                                {% if not user.is_anonymous %}

                                                <div class="d-flex justify-content-between">
                                                    <div class="d-flex">
                                                        <a id="liked_review" class="text-muted" onclick="like_review(`{{ comment.id }}`, event)" href="#!"><i class="fas fa-thumbs-up {% if user in comment.liked.all %} text-primary {% endif %}"></i></a> <div class="ml-2 count_liked_review "><p class="m-0 p-0"> {{ comment.liked.all.count }}</p></div>  
                                                        <a id="dislike_review" class="text-muted" onclick="dislike_review(`{{ comment.id }}`, event)" href="#!"><i class="fas fa-thumbs-down ml-2 {% if user in comment.dislike.all %} text-primary {% endif %}"></i></a> <div class="ml-2 count_dislike_review"><p class="m-0 p-0"> {{ comment.dislike.all.count }}</p></div>
                                                    </div>
                                                    <div class="btn-gtoup dropleft">
                                                        <button class="btn dropdown-toggle" style="background: none;"
                                                                type="button" id="dropdownMenu1" data-toggle="dropdown"
                                                                aria-haspopup="true" aria-expanded="false">
                                                            <i class="fas fa-ellipsis-h"></i>
                                                        </button>
                                                        <div class="dropdown-menu" aria-labelledby="dropdownMenu1" >
                                                            
                                                            <a class="dropdown-item text-muted" href="#"  data-toggle="modal" data-target="#edit_review" onclick="puttext_review_and_put_id_review('{{comment.comment}}', `{{comment.id}}`)"><i class="far fa-edit mr-1"></i>Редагувати</a>
                                                            <a class="dropdown-item text-danger" href="#" onClick="deleteReview(`{{ comment.id }}`, event)"><i class="fas fa-trash-alt mr-1">Видалити</i></a>
                                                        </div>
                                                        </div>
                                                </div>
                                                {% else %}
                                                    <div class="d-flex">
                                                        <a id="liked_review" class="text-muted" onclick="like_review(`{{ comment.id }}`, event)" href="#!"><i class="fas fa-thumbs-up {% if user in comment.liked.all %} text-primary {% endif %}"></i></a> <div class="ml-2 count_liked_review "><p class="m-0 p-0"> {{ comment.liked.all.count }}</p></div>
                                                        <a id="dislike_review" class="text-muted" onclick="dislike_review(`{{ comment.id }}`, event)" href="#!"><i class="fas fa-thumbs-down ml-2 {% if user in comment.dislike.all %} text-primary {% endif %}"></i></a> <div class="ml-2 count_dislike_review"><p class="m-0 p-0"> {{ comment.dislike.all.count }}</p></div>
                                                    </div>
                                                {% endif %}
                                                

                                            </div>
                                            
                                            
                                        </div>  
                                        
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        
                    </div>
                </div>

                <div class="collapse" id="collapseExample">
                    
                </div>
                
                <!-- <input type="submit" value="Бiльше коментарiв" class="btn btn-primary"> -->
                
            </div> 
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="edit_review" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Редагування</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="EditReview_form" action="" method="POST">
                    <input type="hidden" id="id_review" value="">
                    <div class="modal-body">
                        <div class="form-group">
                            <textarea name="edit_review" id="edit_review" class="form-control" rows="5" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Відміна</button>
                        <button type="submit" class="btn btn-primary">Зберегти</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
{% endblock %}

{% block js %} 
<script> 

    const formID = 'form#formReview';
    const formID_edit = 'form#EditReview_form';

    $(formID).on('submit', (e) => {
        e.preventDefault();
        $.ajax({
            
            url: "{% if not user.is_anonymous %}{% url 'app:movie_comment' movie.id user.id %}{% else %}{% url 'app:movie_comment' movie.id 13 %}{% endif %}", // /news/add_review/
            type: 'POST',
            dataType: 'json',
            data: {
                comment: $(formID + ' #comment').val(),
            },
            success: function (data) {
                // var order_data = response.order_data;
                console.log(data)
                CreateReview(data);
                $(formID + ' #comment').val('');
                
                
            }
        });
        
    });
    
    function CreateReview(data){
        
        $('.card-body_comment').prepend(
            `
            <div class="row d-flex p-3 my-3 review-`+data.id_comment+`" >
                <div class="col-md-2">
                    <img class="img-fluid" src="{% static 'img/user.png' %}" alt="user">
                </div>
                <div class="col-md-10 comment">
                    <strong>{% if user.is_anonymous %}Гiсть{% else %}{% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}{% endif %}</strong> <br>
                    <p id="review_for_page">` +data['comment']+ `</p>
                    {% if not user.is_anonymous %}

                    <div class="d-flex justify-content-between">
                        <div class="d-flex">
                            <a id="liked_review" class="text-muted" onclick="like_review(`+data.id_comment+`, event)" href="#!"><i class="fas fa-thumbs-up {% if user in comment.liked.all %} text-primary {% endif %}"></i></a> <div class="ml-2 count_liked_review "><p class="m-0 p-0">`+data.count_liked+`</p></div>  
                            <a id="dislike_review" class="text-muted" onclick="dislike_review(`+data.id_comment+`, event)" href="#!"><i class="fas fa-thumbs-down ml-2 {% if user in comment.dislike.all %} text-primary {% endif %}"></i></a> <div class="ml-2 count_dislike_review"><p class="m-0 p-0">`+data.count_dislike+`</p></div>
                        </div>
                        <div class="btn-gtoup dropleft">
                            <button class="btn dropdown-toggle" style="background: none;"
                                    type="button" id="dropdownMenu1" data-toggle="dropdown"
                                    aria-haspopup="true" aria-expanded="false">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenu1" >
                                
                                <a class="dropdown-item text-muted" href="#"  data-toggle="modal" data-target="#edit_review" onclick="puttext_review_and_put_id_review('`+data.comment+`', `+data.id_comment+`)"><i class="far fa-edit mr-1"></i>Редагувати</a>
                                <a class="dropdown-item text-danger" href="#" onClick="deleteReview(`+data.id_comment+`, event)"><i class="fas fa-trash-alt mr-1">Видалити</i></a>
                            </div>
                            </div>
                    </div>
                    {% else %}
                        <div class="d-flex">
                            <a id="liked_review" class="text-muted" onclick="like_review(`+data.id_comment+`, event)" href="#!"><i class="fas fa-thumbs-up {% if user in comment.liked.all %} text-primary {% endif %}"></i></a> <div class="ml-2 count_liked_review "><p class="m-0 p-0">`+data.count_liked+`</p></div>
                            <a id="dislike_review" class="text-muted" onclick="dislike_review(`+data.id_comment+`, event)" href="#!"><i class="fas fa-thumbs-down ml-2 {% if user in comment.dislike.all %} text-primary {% endif %}"></i></a> <div class="ml-2 count_dislike_review"><p class="m-0 p-0">`+data.count_dislike+`</p></div>
                        </div>
                    {% endif %}
                </div>

            </div> 
            `
        );
        console.log('success added')
    }
    
    $(formID_edit).on('submit', (e) => {
        e.preventDefault();
        $.ajax({
            url: "{% url 'app:update_review' %}",
            type: 'POST',
            datatype:'json',
            data: {
                'id_review': $(formID_edit + ' #id_review').val(),
                'review_edited': $(formID_edit + ' #edit_review').val(),
            },
            success: function(data){
                
                update_review_in_this_page(data);
                $(formID_edit).trigger("reset");
                $('#edit_review').modal('hide');
                console.log('success edited');
            }
        });
    });

     function update_review_in_this_page(data){
        var value = data.review_edited
        $('.review-'+data.id_review+' #review_for_page').text(value);
        
    }

    function puttext_review_and_put_id_review(txt_review, id_review){
        $(formID_edit + ' #edit_review').val(txt_review);
        $(formID_edit + ' #id_review').val(id_review);
    }

    function deleteReview(id_review, e) {
        var action = confirm("Ви впевнені що хочете видалити коментар?");
        e.preventDefault();
        if (action != false) {
            $.ajax({
                url: '{% url "app:ajax_delete" %}',
                data: {
                    'id_review': id_review,
                },
                dataType: 'json',
                success: function (data) {
                    
                    if (data.deleted) {
                        
                        $(".card-body_comment .review-" + id_review).remove();
                        
                    }
                }
            });
        }
    }
    function like_review(id_review, e){
        e.preventDefault();
        $.ajax({
            url: '{% url "app:liked_review" %}',
            data: {
                'id_article': `{{ news.id }}`,
                'id_review': id_review 
            },
            dataType: 'json',
            success: function (data) {
                console.log('success like');
                console.log(data);
                $('.review-' +data.id_review+ ' .count_dislike_review p').text(data.conut_dislike);
                $('.review-' +data.id_review+ ' .count_liked_review p').text(data.count_like);

                if (data.user_liked){
                    $('.review-' +data.id_review+ ' #dislike_review i').removeClass('text-primary');
                    $('.review-' +data.id_review+ ' #liked_review i').addClass('text-primary');
                    
                }else{
                    $('.review-' +data.id_review+ ' #liked_review i').removeClass('text-primary');
                }
                
            }
        });
    }
    function dislike_review(id_review, e){
        e.preventDefault();
        $.ajax({
            url: '{% url "app:dislike_review" %}',
            data: {
                'id_article': `{{ news.id }}`,
                'id_review': id_review 
            },
            dataType: 'json',
            success: function (data) {
                console.log('success dislike');
                console.log(data);
                $('.review-' +data.id_review+ ' .count_dislike_review p').text(data.conut_dislike);
                $('.review-' +data.id_review+ ' .count_liked_review p').text(data.count_like);

                if (data.user_dislike){
                    $('.review-' +data.id_review+ ' #liked_review i').removeClass('text-primary');
                    $('.review-' +data.id_review+ ' #dislike_review i').addClass('text-primary');
                }else{
                    $('.review-' +data.id_review+ ' #dislike_review i').removeClass('text-primary')
                }
                
            }
        });
    }
</script>
    
{% endblock %}