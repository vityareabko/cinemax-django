
{% extends "base.html" %}
{% load static %}
{% load account %}
{% block title %}Новини{% endblock %}
{% block stylesheet %} {% endblock %}

{% block content %}
    <div class="container">
        <div class="card mt-5">
            <div class="card-header">
                <h4>{{news.title}}</h4>
                <p class="mr-5">{{ news.created_at }}</p>
            </div>
            <div class="card-body">
                <p>{{ news.full_describe|linebreaksbr }}</p>
                <br><hr>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex">
                        
                        {% if not user.is_anonymous %}
                            
                            
                            <a id="like" class="text-muted" href="#!" onclick="liked_post(event)"><i class="fas fa-thumbs-up {% if user in news.liked.all %} text-primary {% endif %} "></i></a><div class="ml-2 count_liked "><p class="m-0 p-0"> {{ news.liked.all.count }}</p></div>
                            <a id="dislike" class="text-muted" href="#!" onclick="dislike_post(event)"><i class="fas fa-thumbs-down ml-2 {% if user in news.dislike.all %} text-primary {% endif %} "></i></a><div class="ml-2 count_dislike"><p class="m-0 p-0"> {{ news.dislike.all.count }}</p></div>
                        {% endif %}
                    </div>
                    <div class="d-flex">
                        <p>коментарiв: {{ quantity }}</p>
                    </div>
                </div>
            </div>
          </div>
        <div class="row mt-5">
            <div class="col-md-4">
                <h4 class="mb-4">Новини</h4>
                {% for new in news_list|slice:"3" %}
                    <div class="card text-white bg-primary mb-3 d-inline-block" >
                        <div class="card-header">
                            <a class="text-white" href="{% url 'news:news_detail' new.url %}">{{ new.title }}</a>
                        </div>
                        <div class="card-body">
                            <p>{{ new.short_describe }}</p>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div class="col-md-8">
                <div id="accordion" role="tablist">
                    <div class="card">
                        <div class="card-header" role="tab" id="headingOne">
                            <h5 class="mb-0">
                                <a data-toggle="collapse" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    Ваша думка ?
                                </a>
                            </h5>
                        </div>
                    
                        <div id="collapseOne" class="collapse show" role="tabpanel" aria-labelledby="headingOne">
                            <div class="card-body">
                                {% user_display user as user_display %}
                                <form id="formReview" action="" method="POST">
                                    {% csrf_token %}
                                    <fieldset disabled>
                                        <div class="form-group">
                                            <input type="text" name="name" id="disabledTextInput" class="form-control" placeholder="{{ user.username }}">
                                        </div>
                                    </fieldset>
                                    <textarea name="comment" id="comment" class="form-control" rows="3" required></textarea>
                                    <input class="btn btn-primary form-control mt-2" type="submit" value="залишити коментарий">
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header" role="tab" id="headingTwo">
                            <h5 class="mb-0">
                                <a class="collapsed" data-toggle="collapse" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    коментарi
                                </a> 
                            </h5>
                        </div>
                        <div id="collapseTwo" class="collapse" role="tabpanel" aria-labelledby="headingTwo">
                            <div class="card-body_comment">
                                
                                {% for comment in comments %}
                                    
                                   
                                    <div class="row d-flex p-3 my-3 review-{{comment.id}}" >
                                        <div class="col-md-2">
                                            <img class="img-fluid" src="{% static 'img/user.png' %}" alt="user">
                                        </div>
                                        <div class="col-md-10 comment">
                                            <strong>{% if comment.id_user.first_name %}{{ comment.id_user.first_name }}{% else %}{{ comment.id_user.username }}{% endif %}</strong> <br>
                                            <p id="review_for_page">{{ comment.comment }}</p>
                                            {% if not user.is_anonymous %}
                                                {% if comment.id_user_id == user.id %}
                                                    <div class="d-flex justify-content-between">
                                                        <div>
                                                            <a class="text-muted" href="#"><i class="fas fa-thumbs-up"></i></a>  1
                                                            <a class="text-muted" href="#"><i class="fas fa-thumbs-down ml-2"></i></a> 3
                                                        </div>
                                                        <div class="btn-gtoup dropleft">
                                                            <button class="btn dropdown-toggle" style="background: none;"
                                                                    type="button" id="dropdownMenu1" data-toggle="dropdown"
                                                                    aria-haspopup="true" aria-expanded="false">
                                                                <i class="fas fa-ellipsis-h"></i>
                                                            </button>
                                                            <div class="dropdown-menu" aria-labelledby="dropdownMenu1" >
                                                              
                                                                <a class="dropdown-item text-muted" href="#"  data-toggle="modal" data-target="#edit_review" onclick="puttext_review_and_put_id_review(`{{comment.comment}}`, `{{comment.id}}`)"><i class="far fa-edit mr-1"></i>Редагувати</a>
                                                                <a class="dropdown-item text-danger" href="#" onclick="deleteReview(`{{comment.id}}`, event)"><i class="fas fa-trash-alt mr-1">Видалити</i></a>
                                                            </div>
                                                          </div>
                                                          <!-- onclick="updateReview(`{{ comment.id }}`, event)" -->
                                                    </div>
                                                {% else %}
                                                    <div>
                                                        <a class="text-muted" href="#">підтримую<i class="fas fa-heart mr-1"></i></a>
                                                        <a class="text-muted" href="#">не підтримую<i class="fas fa-heart-broken mr-1"></i></a>
                                                    </div>
                                                {% endif %}
                                                

                                            {% else %}
                                                <div>
                                                    <a class="text-muted" href="#">підтримую<i class="fas fa-heart mr-1"></i></a>
                                                    <a class="text-muted" href="#">не підтримую<i class="fas fa-heart-broken mr-1"></i></a>
                                                </div>
                                            {% endif %}
                                            
                                            {% comment %}
                                            <!-- <p>
                                                <a class="" data-toggle="collapse" href="#{{ comment.id_article_id }}{{ comment.id }}{{ comment.id_user.username }}" aria-expanded="false" aria-controls="collapseExample" onclick="addReview('{% if comment.id_user.first_name %}{{ comment.id_user.first_name }}{% else %}{{ comment.id_user.username }}{% endif %}', '{{ comment.id }}')">
                                                    відповісти <i class="fas fa-reply-all"></i>
                                                </a>
                                                <div class="card">
                                                    <div class="card-header" role="tab" id="headingTwo">
                                                        <h5 class="mb-0">
                                                        <a class="collapsed" style="font-size: 16px;" data-toggle="collapse" href="#{{ comment.id_article_id }}{{ comment.id }}" aria-expanded="false" aria-controls="collapseTwo">
                                                            Показати коментарі <i class="far fa-comment-dots"></i>
                                                        </a>
                                                        </h5>
                                                    </div>
                                                    <div id="{{ comment.id_article_id }}{{ comment.id }}" class="collapse" role="tabpanel" aria-labelledby="headingTwo">
                                                        <div class="card-body">
                                                            
                                                            
                                                                <div class="media row mt-3">
                                                                    <a class="d-flex col-md-2 pr-3" href="#!">
                                                                        <img class="img-fluid" src="{% static 'img/user.png' %}" alt="user">
                                                                    </a>
                                                                    <div class="media-body col-md-10">
                                                                        <h5 class="mt-0">username</h5>
                                                                        comment
                                                                    </div>
                                                                </div>
                                                               
                                                        </div>
                                                    </div>
                                                </div>
                                            </p> -->
                                            <!-- <div class="collapse" id="{{ comment.id_article_id }}{{ comment.id }}{{ comment.id_user.username }}">
                                                <div class="card card-body">
                                                    <form id="formReview_reply" action="{% if user_display %} {% url 'news:article_comments' news.id user.id %} {% else %} {% url 'news:article_comments' news.id 13 %} {% endif %}" method="POST">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="parent" id="contactparent" value="{{ comment.id_user_id }}" >
                                                        <input type="hidden" name="id_reply_user" value="{{ comment.id }}" >

                                                        <textarea name="comment" id="comment_reply{{ comment.id }}" class="form-control" rows="3" required></textarea>
                                                        <input class="btn btn-primary form-control mt-2" type="submit" value="відповісти">
                                                    </form>
                                                </div>
                                            </div> -->
                                            {% endcomment %}
                                            
                                        </div>
                                    </div> 
                                    
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        
    </div>
    
    <!-- Modal -->
    <div class="modal fade" id="edit_review" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Редагування</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="EditReview_form" action="" method="POST">
                    <input type="hidden" id="id_review" value="">
                    <div class="modal-body">
                        <div class="form-group">
                            <textarea name="edit_review" id="edit_review" class="form-control" rows="5" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Відміна</button>
                        <button type="submit" class="btn btn-primary">Зберегти</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock  %}
    
{% block js %}

<script> 
        
const formID = 'form#formReview';
const formID_edit = 'form#EditReview_form';

$(formID).on('submit', (e) => {
    e.preventDefault();
    $.ajax({
        
        url: "{% if not user.is_anonymous %}{% url 'news:add_review' news.id user.id %}{% else %}{% url 'news:add_review' news.id 13 %}{% endif %}", // /news/add_review/
        type: 'POST',
        dataType: 'json',
        data: {
            comment: $(formID + ' #comment').val(),
        },
        success: function (data) {
            // var order_data = response.order_data;
            console.log(data)
            CreateReview(data);
            $(formID + ' #comment').val('');
            
            
        }
    });
    
});
function CreateReview(data){
    
    $('.card-body_comment').prepend(
        `
        <div class="row d-flex p-3 my-3 review-`+data.id_comment+`" >
            <div class="col-md-2">
                <img class="img-fluid" src="{% static 'img/user.png' %}" alt="user">
            </div>
            <div class="col-md-10 comment">
                <strong>{% if user.is_anonymous %}Гiсть{% else %}{% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}{% endif %}</strong> <br>
                <p id="review_for_page">` +data['comment']+ `</p>
                {% if not user.is_anonymous %}

                <div class="d-flex justify-content-between">
                    <div>
                        <a class="text-muted" href="#"><i class="fas fa-heart mr-1"></i></a>
                        <a class="text-muted" href="#"><i class="fas fa-heart-broken mr-1"></i></a>
                    </div>
                    <div class="btn-gtoup dropleft">
                        <button class="btn dropdown-toggle" style="background: none;"
                                type="button" id="dropdownMenu1" data-toggle="dropdown"
                                aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <div class="dropdown-menu" aria-labelledby="dropdownMenu1" >
                            
                            <a class="dropdown-item text-muted" href="#"  data-toggle="modal" data-target="#edit_review" onclick="puttext_review_and_put_id_review('`+data.comment+`', `+data.id_comment+`)"><i class="far fa-edit mr-1"></i>Редагувати</a>
                            <a class="dropdown-item text-danger" href="#" onClick="deleteReview(`+data.id_comment+`, event)"><i class="fas fa-trash-alt mr-1">Видалити</i></a>
                        </div>
                        </div>
                </div>
                {% else %}
                    <div>
                        <a class="text-muted" href="#"><i class="fas fa-heart mr-1"></i></a>
                        <a class="text-muted" href="#"><i class="fas fa-heart-broken mr-1"></i></a>
                    </div>
                {% endif %}
            </div>

        </div> 
        `
    );
    console.log('success added')
}
$(formID_edit).on('submit', (e) => {
    e.preventDefault();
    $.ajax({
        url: "{% url 'news:update_review' %}",
        type: 'POST',
        datatype:'json',
        data: {
            'id_review': $(formID_edit + ' #id_review').val(),
            'review_edited': $(formID_edit + ' #edit_review').val(),
        },
        success: function(data){
            
            update_review_in_this_page(data);
            $(formID_edit).trigger("reset");
            $('#edit_review').modal('hide');
            console.log('success edited');
        }
    });
});

// Delete Django Ajax Call
function deleteReview(id_review, e) {
    var action = confirm("Ви впевнені що хочете видалити коментар?");
    e.preventDefault();
    if (action != false) {
        $.ajax({
            url: '{% url "news:ajax_delete" %}',
            data: {
                'id_review': id_review,
            },
            dataType: 'json',
            success: function (data) {
                
                if (data.deleted) {
                    
                    $(".card-body_comment .review-" + id_review).remove();
                    
                }
            }
        });
    }
}

function update_review_in_this_page(data){
    var value = data.review_edited
    $('.review-'+data.id_review+' #review_for_page').text(value);
    
}

function puttext_review_and_put_id_review(txt_review, id_review){
    $(formID_edit + ' #edit_review').val(txt_review);
    $(formID_edit + ' #id_review').val(id_review);
}

function liked_post(e){
    e.preventDefault();
    $.ajax({
        url: '{% url "news:liked_post" %}',
        data: {
            'id_article': `{{ news.id }}`,
        },
        dataType: 'json',
        success: function (data) {
            console.log('success liked');
            console.log(data);
            $('.count_dislike p').text(data.conut_dislike);
            $('.count_liked p').text(data.count_like);
            
            if (data.user_liked){
                $('#dislike i').removeClass('text-primary');
                $('#like i').addClass('text-primary');
            }else{
                $('#like i').removeClass('text-primary');
            }
                
         
                // $('#like i').removeClass('text-primary');
           
            
        }   
    });
}

function dislike_post(e){
    e.preventDefault();
    $.ajax({
        url: '{% url "news:dislike_post" %}',
        data: {
            'id_article': `{{ news.id }}`,
        },
        dataType: 'json',
        success: function (data) {
            console.log('success dislike');
            console.log(data);
            $('.count_dislike p').text(data.conut_dislike);
            $('.count_liked p').text(data.count_like);

            if (data.user_dislike){
                $('#like i').removeClass('text-primary');
                $('#dislike i').addClass('text-primary');
            }else{
                $('#dislike i').removeClass('text-primary');
            }
        }
    });
}



</script>

{% endblock %}
    